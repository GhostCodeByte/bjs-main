<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flask Layout</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='input.css') }}"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-between mt-3">
        <div>
          <select id="riegenfuehrer" class="form-select d-inline w-auto">
            <option value="" selected disabled>Riegenf체hrer</option>
            {% for riegen in riegenfuehrer %}
            <option value="{{ riegen[0] }}">{{ riegen[1] }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-info ms-2" type="button" onclick="get_riege()">
            Get
          </button>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="text-muted small ms-2">
            Station: <strong>{{ station }}</strong>
            <span class="ms-2"
              >iPad: <strong>{{ ipad_stations_nummer }}</strong></span
            >
          </div>
          <a class="btn btn-danger ms-2" href="/logout">Logout</a>
        </div>
      </div>

      <div class="d-flex mt-4 gap-4">
        <div class="box p-3">
          <p><strong>Klasse:</strong> <span id="klasse"></span></p>
          <p><strong>Geschlecht:</strong> <span id="geschlecht"></span></p>

          <div class="mt-3">
            <p class="mb-1"><strong>Fortschritt pro Runde:</strong></p>
            <p class="mb-1">
              <span class="badge bg-secondary">Runde 1:</span>
              <span id="runde1_fertig">{{ runde1_fertig }}</span>/<span
                id="schueler_gesamt_r1"
                >{{ schueler_gesamt - schueler_abwesend }}</span
              >
            </p>
            <p class="mb-1">
              <span class="badge bg-secondary">Runde 2:</span>
              <span id="runde2_fertig">{{ runde2_fertig }}</span>/<span
                id="schueler_gesamt_r2"
                >{{ schueler_gesamt - schueler_abwesend }}</span
              >
            </p>
            <p class="mb-1">
              <span class="badge bg-secondary">Runde 3:</span>
              <span id="runde3_fertig">{{ runde3_fertig }}</span>/<span
                id="schueler_gesamt_r3"
                >{{ schueler_gesamt - schueler_abwesend }}</span
              >
            </p>
          </div>

          <div class="mt-3">
            <p class="mb-1">
              <span class="badge bg-danger">Abwesend:</span>
              <span id="schueler_abwesend">{{ schueler_abwesend }}</span>
            </p>
          </div>
        </div>
        <div class="box p-3 flex-grow-1">
          <div class="d-flex justify-content-between">
            <div>
              <p><strong>Name:</strong> <span id="selectedSchueler"></span></p>
              <p><strong>Schwierigkeitsgrad:</strong></p>
            </div>
            <select
              id="schuelerDropdown"
              class="form-select w-auto"
              style="height: 50%"
            >
              <option value="" selected disabled>Sch체ler</option>
            </select>
          </div>
          <div class="d-flex align-items-center mt-2 gap-3">
            <input
              type="text"
              id="ergebnis"
              class="form-control w-50"
              placeholder="mm:ss"
              inputmode="numeric"
              enterkeyhint="next"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
              pattern="[0-9:]*"
            />
            <div
              id="current-result-display"
              class="text-muted"
              style="min-width: 150px"
            ></div>
          </div>
          <div class="d-flex justify-content-between mt-4">
            <button
              class="btn btn-success"
              type="button"
              onclick="nextStudent()"
            >
              N채chster
            </button>
            <div class="d-flex gap-2">
              <button
                class="toggle-btn btn btn-outline-secondary"
                type="button"
              >
                Runde 1
              </button>
              <button
                class="toggle-btn btn btn-outline-secondary"
                type="button"
              >
                Runde 2
              </button>
              <button
                class="toggle-btn btn btn-outline-secondary"
                type="button"
              >
                Runde 3
              </button>
            </div>
            <button class="btn btn-danger" type="button">Abwesend</button>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
    function updateSchuelerDropdown(statusList, keepSelectedId = null) {
      const schuelerDropdown = document.getElementById("schuelerDropdown");
      const prevSelectedId = keepSelectedId ?? schuelerDropdown.value ?? "";

      schuelerDropdown.innerHTML =
        '<option value="" selected disabled>Sch체ler</option>';

      statusList.forEach((schuelerStr) => {
        const [id, nameAndRounds] = schuelerStr.split(": ");
        const option = document.createElement("option");
        option.value = id;
        option.textContent = nameAndRounds;
        schuelerDropdown.appendChild(option);
      });

      if (prevSelectedId) {
        const idx = Array.from(schuelerDropdown.options).findIndex(
          (opt) => opt.value === prevSelectedId
        );
        if (idx >= 0) {
          schuelerDropdown.selectedIndex = idx;
          document.getElementById("selectedSchueler").textContent =
            schuelerDropdown.options[idx].textContent;
        }
      }
    }

    function get_riege() {
      const riegenfuehrerSelect = document.getElementById("riegenfuehrer");
      const riegenfuehrerId = riegenfuehrerSelect.value;

      fetch(`/get_riege`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ riegenfuehrer_id: riegenfuehrerId }),
      })
        .then((response) => response.json())
        .then((data) => {
          updateSchuelerDropdown(data);
          const schuelerDropdown = document.getElementById("schuelerDropdown");
          if (schuelerDropdown.options.length > 1) {
            schuelerDropdown.selectedIndex = 1;
            document.getElementById("selectedSchueler").textContent =
              schuelerDropdown.options[1].textContent;
          }
        })
        .catch((error) => console.error("Error fetching schueler:", error));
    }

    function nextStudent() {
      const schuelerDropdown = document.getElementById("schuelerDropdown");
      const selectedOption =
        schuelerDropdown.options[schuelerDropdown.selectedIndex];
      const schuelerId = selectedOption?.value;
      const ergebnis = document.getElementById("ergebnis").value;
      const round = getActiveRound();

      fetch(`/next_student`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          schueler_id: schuelerId,
          ergebnis: ergebnis,
          round: round,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          updateSchuelerDropdown(data, schuelerId);

          const sd = document.getElementById("schuelerDropdown");
          const currentIdx = Array.from(sd.options).findIndex(
            (o) => o.value === schuelerId
          );
          const nextIndex = currentIdx + 1;

          if (nextIndex > 0 && nextIndex < sd.options.length) {
            sd.selectedIndex = nextIndex;
            const nextOption = sd.options[nextIndex];
            document.getElementById("selectedSchueler").textContent =
              nextOption.textContent;
            document.getElementById("ergebnis").value = "";
          } else if (getActiveRound() < 3) {
            setActiveRound(getActiveRound() + 1);
            schuelerDropdown.selectedIndex = 1;
            document.getElementById("selectedSchueler").textContent =
              schuelerDropdown.options[1].textContent;
          } else {
            schuelerDropdown.selectedIndex = 0;
            document.getElementById("selectedSchueler").textContent = "";
            document.getElementById("ergebnis").value = "";
            setActiveRound(1);
          }
        })
        .catch((error) => console.error("Error in nextStudent:", error));
    }

    const buttons = document.querySelectorAll(".toggle-btn");
    buttons.forEach((btn, index) => {
      btn.addEventListener("click", () => {
        setActiveRound(index + 1);
      });
    });

    function setActiveRound(num) {
      if (num < 1 || num > buttons.length) return;
      buttons.forEach((btn, i) => {
        if (i === num - 1) btn.classList.add("active");
        else btn.classList.remove("active");
      });
    }

    function getActiveRound() {
      let activeIndex = -1;
      buttons.forEach((btn, i) => {
        if (btn.classList.contains("active")) activeIndex = i + 1;
      });
      return activeIndex;
    }

    setActiveRound(1);
  </script>
</html>
